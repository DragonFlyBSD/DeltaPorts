--- Makefile.orig	2024-01-25 00:16:32 UTC
+++ Makefile
@@ -5,6 +5,7 @@ CATEGORIES=	lang
 MASTER_SITES=	SF/freepascal/Source/${PORTVERSION}:source \
 		https://downloads.freepascal.org/${PORTNAME}/dist/${PORTVERSION}/source/:source \
 		http://leaf.dragonflybsd.org/~marino/dports-src/:DragonFlybootstrap \
+		http://avalon.dragonflybsd.org/misc/distfiles/freepascal/:DragonFlybootstrap \
 		LOCAL/acm/freepascal/:bootstrap \
 		LOCAL/acm/freepascal/:man
 DISTFILES=	${DISTNAME:S/$/.source/}${EXTRACT_SUFX}:source
@@ -16,7 +17,7 @@ WWW=		https://www.freepascal.org/
 
 CONFLICTS=	fpc-devel
 
-RUN_DEPENDS=	${LOCALBASE}/bin/as:devel/binutils
+RUN_DEPENDS=	${LOCALBASE}/bin/as:devel/binutils@native
 
 ONLY_FOR_ARCHS=	amd64 i386
 
@@ -25,7 +26,7 @@ USE_BINUTILS=	yes
 BOOTVER=	${PORTVERSION}
 MANVER=		${PORTVERSION}
 
-FPC_LDPATH?=	"${LOCALBASE}/bin/ld.bfd"
+FPC_LDPATH?=	"/usr/bin/ld.bfd"
 
 FPCSRCDIR=	${PORTNAME}-${PORTVERSION}
 
@@ -37,7 +38,7 @@ FPC_ARCH=	i386
 #OPT=		"-dFPC_USE_LIBC"
 PLIST_SUB+=	FPC_I386="" \
 		FPC_AMD64="@comment "
-.elif ${ARCH} == "amd64"
+.elif ${ARCH} == "x86_64"
 PPNAME=		ppcx64
 FPC_ARCH=	x86_64
 #OPT=		"-dFPC_USE_LIBC"
@@ -108,48 +109,80 @@ post-patch:
 		${WRKDIR}/${FPCSRCDIR}/packages/fpmkunit/src/fpmkunit.pp
 
 # enable units
-	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,linux|g' \
+	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,dragonfly,linux|g' \
 		${WRKSRC}/packages/a52/fpmake.pp
-	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,linux|g' \
+	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,dragonfly,linux|g' \
 		${WRKSRC}/packages/dts/fpmake.pp
 	@${REINPLACE_CMD} -i "" -e 's|freebsd,||g' \
+		-e 's|,dragonfly||g' \
 		${WRKSRC}/packages/fpgtk/fpmake.pp
-	@${REINPLACE_CMD} -i "" -e 's|iphonesim|freebsd,iphonesim|g' \
+	@${REINPLACE_CMD} -i "" -e 's|iphonesim|freebsd,dragonfly,iphonesim|g' \
 		${WRKSRC}/packages/gnome1/fpmake.pp
-	@${REINPLACE_CMD} -i "" -e 's|iphonesim|freebsd,iphonesim|g' \
+	@${REINPLACE_CMD} -i "" -e 's|iphonesim|freebsd,dragonfly,iphonesim|g' \
 		${WRKSRC}/packages/gtk1/fpmake.pp
-	@${REINPLACE_CMD} -i "" -e 's|iphonesim|freebsd,iphonesim|g' \
+	@${REINPLACE_CMD} -i "" -e 's|iphonesim|freebsd,dragonfly,iphonesim|g' \
 		${WRKSRC}/packages/imlib/fpmake.pp
-	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,linux|g' \
+	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,dragonfly,linux|g' \
 		${WRKSRC}/packages/ldap/fpmake.pp
-	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,linux|g' \
+	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,dragonfly,linux|g' \
 		${WRKSRC}/packages/libsee/fpmake.pp
-	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,linux|g' \
+	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,dragonfly,linux|g' \
 		${WRKSRC}/packages/lua/fpmake.pp
-	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,linux|g' \
+	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,dragonfly,linux|g' \
 		${WRKSRC}/packages/mad/fpmake.pp
-	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,linux|g' \
+	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,dragonfly,linux|g' \
 		${WRKSRC}/packages/modplug/fpmake.pp
-	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,linux|g' \
+	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,dragonfly,linux|g' \
 		${WRKSRC}/packages/newt/fpmake.pp
-	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,linux|g' \
+	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,dragonfly,linux|g' \
 		${WRKSRC}/packages/oggvorbis/fpmake.pp
-	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,linux|g' \
+	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,dragonfly,linux|g' \
 		${WRKSRC}/packages/openal/fpmake.pp
-	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,linux|g' \
+	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,dragonfly,linux|g' \
 		${WRKSRC}/packages/opencl/fpmake.pp
-	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,linux|g' \
+	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,dragonfly,linux|g' \
 		${WRKSRC}/packages/proj4/fpmake.pp
-	@${REINPLACE_CMD} -i "" -e 's|os2|freebsd,os2|g' \
+	@${REINPLACE_CMD} -i "" -e 's|os2|freebsd,dragonfly,os2|g' \
 		${WRKSRC}/packages/rexx/fpmake.pp
-	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,linux|g' \
+	@${REINPLACE_CMD} -i "" -e 's|linux|freebsd,dragonfly,linux|g' \
 		${WRKSRC}/packages/zorba/fpmake.pp
 
+# dragonfly specifics
+	@${REINPLACE_CMD} -i "" -e 's|,dragonfly||g' \
+		${WRKSRC}/packages/fpgtk/fpmake.pp
+	@${REINPLACE_CMD} -i "" -e 's|freebsd,|freebsd,dragonfly,|g' \
+		${WRKSRC}/packages/users/fpmake.pp
+	@${REINPLACE_CMD} -i "" -e 's|freebsd,|freebsd,dragonfly,|g' \
+		${WRKSRC}/utils/instantfpc/fpmake.pp \
+		${WRKSRC}/utils/fpcres/fpmake.pp
+	@${REINPLACE_CMD} -i "" -e 's|freebsd|freebsd, dragonfly|g' \
+		${WRKSRC}/packages/fcl-report/fpmake.pp
+	@${REINPLACE_CMD} -i "" -e 's|openbsd, |openbsd, dragonfly, |g' \
+		${WRKSRC}/packages/ide/fpmake.pp
+	@${REINPLACE_CMD} -i "" -e 's|freebsd,|freebsd,dragonfly,|g' \
+		${WRKSRC}/packages/libxml/fpmake.pp
+	@${REINPLACE_CMD} -i "" -e 's|freebsd,|freebsd,dragonfly,|g' \
+		${WRKSRC}/packages/gmp/fpmake.pp
+	@${REINPLACE_CMD} -i "" -e '/cnetdb/ s/freebsd,/freebsd,dragonfly,/g' \
+		${WRKSRC}/packages/fcl-net/fpmake.pp
+	@${REINPLACE_CMD} -i "" -e 's/freebsd,/freebsd,dragonfly,/g' \
+		${WRKSRC}/packages/fcl-xml/fpmake.pp
+	@${REINPLACE_CMD} -i "" -e 's/freebsd,/freebsd,dragonfly,/g' \
+		-e '/ggigraph/ s/freebsd/freebsd,dragonfly/g' \
+		${WRKSRC}/packages/graph/fpmake.pp
+	@${REINPLACE_CMD} -i "" -e 's/freebsd,/freebsd,dragonfly,/g' \
+		${WRKSRC}/packages/iconvenc/fpmake.pp
+	@${REINPLACE_CMD} -i "" -e 's/freebsd,/freebsd,dragonfly,/g' \
+		${WRKSRC}/packages/libfontconfig/fpmake.pp
+	@${REINPLACE_CMD} -i ""	-e 's/freebsd,/freebsd,dragonfly,/g' \
+		-e '/P.OSes/ s/freebsd/freebsd, dragonfly/g' \
+		${WRKSRC}/packages/libvlc/fpmake.pp
+
 do-build:
 # build fpc compiler
 	@${ECHO_MSG} "##### STARTING COMPILER #####"
 	(cd ${WRKDIR}/${FPCSRCDIR}/compiler && ${SETENV} ${MAKE_ENV} \
-		${MAKE_CMD} cycle ${MAKE_ARGS} ${BOOTPPC})
+		LDVER=ld.bfd ${MAKE_CMD} cycle ${MAKE_ARGS} ${BOOTPPC})
 	@${ECHO_MSG} "##### COMPLETE COMPILER #####"
 
 # build units
@@ -174,6 +207,9 @@ do-install:
 		"${STAGEDIR}${PREFIX}/etc"
 	@${REINPLACE_CMD} -i "" -e 's|${STAGEDIR}||' \
 		-e 's|^#-Fl/lib;/usr/lib|-Fl${LOCALBASE}/lib;${LOCALBASE}/lib/qt5;${LOCALBASE}/lib/qt6|g' \
-		${STAGEDIR}${PREFIX}/etc/fpc.cfg.sample
+			${STAGEDIR}${PREFIX}/etc/fpc.cfg.sample \
+			${STAGEDIR}${PREFIX}/etc/fppkg.cfg.sample \
+			${STAGEDIR}${PREFIX}/etc/fppkg/default \
+			${STAGEDIR}${PREFIX}/lib/fpc/${PORTVERSION}/ide/text/fp.cfg
 
 .include <bsd.port.post.mk>
